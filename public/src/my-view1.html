<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view1">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
    </style>

    <div class="card">
      <h1>Watering Data</h1>
      <p>Below you can find the last 10 watering events</p>
      <canvas id="myChart" width="400" height="400"></canvas>

    </div>
  </template>

  <script src="../bower_components/chart.js/dist/Chart.min.js"></script>
  <script>
    class MyView1 extends Polymer.Element {
      static get is() {
        return 'my-view1';
      }

      generateChart(labels, data) {
        //ChartJs
        var ctx = this.$.myChart.getContext('2d');
        var chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: "Watering Durations",
              backgroundColor: '#550044',
              borderColor: 'rgb(255, 99, 132)',
              data: data,
            }]
          },
          options: {
            scales: {
              yAxes: [{
                ticks: {
                  beginAtZero: true
                }
              }]
            }
          }
        });
      }

      convertTimestamp(unix_timestamp) {
        var date = new Date(unix_timestamp * 1000);
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var month = months[date.getMonth()];
        var day = date.getDate();
        var hours = date.getHours();
        var minutes = "0" + date.getMinutes();
        return month + ' '  + day + ' - ' + hours + ':' + minutes.substr(-2);
      }


      ready() {
        super.ready();

        var thisEl = this;
        // Get a reference to the database service
        var data = [];
        var labels = [];
        var database = firebase.database();
        firebase.database().ref('bazzini/pizerow/watering').limitToLast(10).once('value').then(function(snapshot) {
          snapshot.forEach(function(childSnapshot) {
            data.push({
              x: Number(childSnapshot.val().watering_init),
              y: Number(childSnapshot.val().watering_duration)
            });
            labels.push(thisEl.convertTimestamp(childSnapshot.val().watering_init));
          });
          // chart.data.datasets[0].data = freq_arr;
          // chart.data.labels.push("ciao");
          // chart.data.datasets.forEach((dataset) => {
          //     dataset.data.push(5);
          // });
          // chart.update();
        }).then(function(res) {
          thisEl.generateChart(labels, data);
        })


      }
    }

    window.customElements.define(MyView1.is, MyView1);
  </script>
</dom-module>
